<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncPlanner | Secure Task Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* Custom Scrollbar für Webkit (Chrome/Brave etc.) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        body { background-color: #111827; color: #e5e7eb; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">

    <div v-if="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div v-if="!session" class="w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700 fade-enter-active">
        <h1 class="text-3xl font-bold text-center mb-2 text-white">SyncPlanner</h1>
        <p class="text-gray-400 text-center mb-6 text-sm">End-to-End Encrypted Workflow</p>
        
        <form @submit.prevent="handleLogin" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300">E-Mail (Anonym möglich)</label>
                <input v-model="email" type="email" required class="mt-1 w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 text-white outline-none transition">
            </div>
            <div>
                 <label class="block text-sm font-medium text-gray-300">Passwort</label>
                 <input v-model="password" type="password" required class="mt-1 w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 text-white outline-none transition">
            </div>
            <button type="submit" :disabled="authLoading" class="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold shadow-lg transform transition active:scale-95 disabled:opacity-50">
                {{ authLoading ? 'Verarbeite...' : 'Einloggen / Registrieren' }}
            </button>
            <p class="text-xs text-center text-gray-500 mt-4">Neue Nutzer werden automatisch registriert.</p>
        </form>
    </div>

    <div v-else class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6 fade-enter-active">
        
        <div class="lg:col-span-3 flex justify-between items-center bg-gray-800 p-4 rounded-xl border border-gray-700">
            <div>
                <h2 class="text-xl font-bold text-white">Dashboard</h2>
                <p class="text-sm text-gray-400">Angemeldet als: {{ session.user.email }}</p>
            </div>
            <button @click="handleLogout" class="px-4 py-2 bg-red-500/10 text-red-400 hover:bg-red-500/20 rounded-lg border border-red-500/20 transition text-sm">
                Abmelden
            </button>
        </div>

        <div class="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700 p-6 shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <button @click="changeMonth(-1)" class="p-2 hover:bg-gray-700 rounded-full text-gray-400"><i class="fas fa-chevron-left"></i></button>
                <h3 class="text-lg font-semibold text-white">{{ currentMonthName }} {{ currentYear }}</h3>
                <button @click="changeMonth(1)" class="p-2 hover:bg-gray-700 rounded-full text-gray-400"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="grid grid-cols-7 gap-2 mb-2">
                <div v-for="day in weekDays" class="text-center text-xs font-bold text-gray-500 uppercase">{{ day }}</div>
            </div>
            <div class="grid grid-cols-7 gap-2">
                <div v-for="(date, index) in calendarDays" :key="index" 
                     @click="selectDate(date)"
                     :class="['h-24 p-2 rounded-lg border border-gray-700/50 flex flex-col transition cursor-pointer relative overflow-hidden', 
                              isToday(date) ? 'bg-indigo-900/30 border-indigo-500/50' : 'bg-gray-700/30 hover:bg-gray-700/50',
                              isSelected(date) ? 'ring-2 ring-indigo-500' : '',
                              !date.currentMonth ? 'opacity-30' : '']">
                    
                    <span class="text-sm font-medium" :class="isToday(date) ? 'text-indigo-400' : 'text-gray-300'">
                        {{ date.day }}
                    </span>
                    
                    <div class="mt-auto flex flex-wrap gap-1">
                        <div v-for="todo in getTodosForDate(date)" :key="todo.id"
                             :class="['w-2 h-2 rounded-full', todo.completed ? 'bg-green-500' : 'bg-red-500']"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 shadow-xl flex flex-col h-[600px]">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-indigo-400">{{ selectedDate ? formatDate(selectedDate) : 'Alle Aufgaben' }}</span>
            </h3>

            <form @submit.prevent="addTodo" class="flex gap-2 mb-6">
                <input v-model="newTask" type="text" placeholder="Neue Aufgabe..." required
                       class="flex-1 px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:ring-1 focus:ring-indigo-500 text-white outline-none">
                <input v-model="newTaskTime" type="time" required
                       class="px-2 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white outline-none">
                <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white transition">
                    <i class="fas fa-plus"></i>
                </button>
            </form>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                <div v-if="filteredTodos.length === 0" class="text-center text-gray-500 mt-10">
                    <p>Keine Aufgaben für diesen Tag.</p>
                </div>

                <div v-for="todo in filteredTodos" :key="todo.id" 
                     class="group flex items-center justify-between p-3 bg-gray-700/40 rounded-lg border border-gray-700 hover:border-gray-500 transition">
                    
                    <div class="flex items-center gap-3 overflow-hidden">
                        <button @click="toggleTodo(todo)" 
                                :class="['w-5 h-5 rounded border flex items-center justify-center transition', 
                                         todo.completed ? 'bg-green-500 border-green-500' : 'border-gray-400 hover:border-indigo-400']">
                            <i v-if="todo.completed" class="fas fa-check text-xs text-white"></i>
                        </button>
                        <div class="flex flex-col overflow-hidden">
                            <span :class="['truncate text-sm', todo.completed ? 'text-gray-500 line-through' : 'text-gray-200']">{{ todo.task }}</span>
                            <span class="text-xs text-gray-500 flex items-center gap-1">
                                <i class="far fa-clock"></i> {{ formatTime(todo.due_date) }}
                            </span>
                        </div>
                    </div>

                    <button @click="deleteTodo(todo.id)" class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

// ------------------------------------------------------------------
// KONFIGURATION
// ------------------------------------------------------------------
const SB_URL = 'https://ojidispbbtonpgceawne.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qaWRpc3BiYnRvbnBnY2Vhd25lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMTc4NTcsImV4cCI6MjA4NDU5Mzg1N30.9Tyw_eew3UrTwsIf-t_DSZ_txsnVlSZTN0SNH1WCq1E';
// ------------------------------------------------------------------

// Wir nennen die Variable hier 'supabaseClient', um den Konflikt zu vermeiden
const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

createApp({
    setup() {
        const loading = ref(true);
        const authLoading = ref(false);
        const session = ref(null);
        const email = ref('');
        const password = ref('');
        const todos = ref([]);
        
        const currentDate = ref(new Date());
        const selectedDate = ref(new Date());
        const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        const newTask = ref('');
        const newTaskTime = ref('12:00');

        onMounted(async () => {
            try {
                // Zugriff über supabaseClient
                const { data, error } = await supabaseClient.auth.getSession();
                if (error) throw error;
                
                session.value = data.session;
                if (session.value) {
                    await fetchTodos();
                }
            } catch (e) {
                console.error("Initialisierungsfehler:", e);
            } finally {
                loading.value = false;
            }

            supabaseClient.auth.onAuthStateChange((_event, _session) => {
                session.value = _session;
                if (_session) fetchTodos();
            });

            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
            setInterval(checkNotifications, 60000); 
        });

        const handleLogin = async () => {
            if (!email.value || !password.value) return;
            authLoading.value = true;
            const { error: signInError } = await supabaseClient.auth.signInWithPassword({ 
                email: email.value, 
                password: password.value 
            });
            if (signInError) {
                const { error: signUpError } = await supabaseClient.auth.signUp({ 
                    email: email.value, 
                    password: password.value 
                });
                if (signUpError) alert("Fehler: " + signUpError.message);
                else alert("Account erstellt! Falls konfiguriert, E-Mail bestätigen.");
            }
            authLoading.value = false;
        };

        const handleLogout = async () => {
            await supabaseClient.auth.signOut();
            todos.value = [];
        };

        const fetchTodos = async () => {
            const { data, error } = await supabaseClient
                .from('todos')
                .select('*')
                .order('due_date', { ascending: true });
            if (!error) todos.value = data;
        };

        const addTodo = async () => {
            if (!newTask.value || !session.value) return;
            const d = new Date(selectedDate.value);
            const [hours, minutes] = newTaskTime.value.split(':');
            d.setHours(parseInt(hours), parseInt(minutes));

            const { data, error } = await supabaseClient
                .from('todos')
                .insert([{ 
                    user_id: session.value.user.id,
                    task: newTask.value,
                    due_date: d.toISOString(),
                    completed: false
                }])
                .select();

            if (!error) {
                todos.value.push(data[0]);
                newTask.value = '';
            }
        };

        const toggleTodo = async (todo) => {
            const newState = !todo.completed;
            todo.completed = newState;
            await supabaseClient.from('todos').update({ completed: newState }).eq('id', todo.id);
        };

        const deleteTodo = async (id) => {
            todos.value = todos.value.filter(t => t.id !== id);
            await supabaseClient.from('todos').delete().eq('id', id);
        };

        // Kalender-Logik (unverändert)
        const currentYear = computed(() => currentDate.value.getFullYear());
        const currentMonthName = computed(() => currentDate.value.toLocaleString('de-DE', { month: 'long' }));
        const calendarDays = computed(() => {
            const year = currentDate.value.getFullYear();
            const month = currentDate.value.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startOffset = firstDay === 0 ? 6 : firstDay - 1;
            const days = [];
            for (let i = 0; i < startOffset; i++) days.push({ day: '', currentMonth: false });
            for (let i = 1; i <= daysInMonth; i++) days.push({ day: i, dateObj: new Date(year, month, i), currentMonth: true });
            return days;
        });

        const changeMonth = (d) => currentDate.value = new Date(currentDate.value.setMonth(currentDate.value.getMonth() + d));
        const selectDate = (d) => { if (d.dateObj) selectedDate.value = d.dateObj; };
        const isToday = (d) => d.dateObj && d.dateObj.toDateString() === new Date().toDateString();
        const isSelected = (d) => d.dateObj && d.dateObj.toDateString() === selectedDate.value.toDateString();
        const getTodosForDate = (d) => {
            if (!d.dateObj) return [];
            return todos.value.filter(t => new Date(t.due_date).toDateString() === d.dateObj.toDateString());
        };
        const filteredTodos = computed(() => getTodosForDate({ dateObj: selectedDate.value }));
        const formatDate = (d) => d.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long' });
        const formatTime = (iso) => new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

        const checkNotifications = () => {
            const now = new Date();
            todos.value.forEach(t => {
                if (t.completed) return;
                const due = new Date(t.due_date);
                if (due - now < 0 && due - now > -60000) {
                    new Notification("Aufgabe fällig!", { body: t.task });
                }
            });
        };

        return {
            loading, authLoading, session, email, password, handleLogin, handleLogout,
            currentYear, currentMonthName, calendarDays, changeMonth, weekDays,
            selectDate, isToday, isSelected, getTodosForDate, selectedDate, formatDate, formatTime,
            newTask, newTaskTime, addTodo, toggleTodo, deleteTodo, filteredTodos
        };
    }
}).mount('#app');
</script>
</body>
</html>
